## 本文主要内容
- 概述
- 整体设计和实现


## 一、概述

**背景:**

机器人在运行过程中需要一个系统采集各节点的数据，状态和机器人自身的状态和数据(感知)，然后根据感知的各种数据和需求决策(决策)控制机器人行为(Action)。


**该系统在机器人架构中的位置:**

该系统为机器人本体上的中央控制系统，向下采集和监控各个节点的运行状况和数据，整体计算决策出机器人所处的场景，然后根据所处的场景执行相应的行为，向上提供展示机器人运行状况的数据以及操作机器人的接口等功能。

**难点:**

1. 机器人在运行过程中会有n种场景(e.g: 导航中、激光故障、维护、PLC操作、空闲......)，且会一直增加变化。
2. 每种场景都需要执行某些操作的集合且集合中的操作会根据需求变化(e.g: 激光故障时候，需要停止机器人正在执行的任务，不能接收新的任务、灯光、显示屏、语音提示等操作，同时可以通过界面可以查看激光模块运行的健康状况，方便排查)。

## 二、整体设计和实现

根据一中的背景和难点整个系统大致可分为三部分。第一部分为==感知==其中包括机器人各种传感器数据、机器人自身的运行数据(e.g: 速度、电量等)、运行在机器人上各节点模块的健康状态。第二部分为==决策==，根据第一部分感知集合结合业务需求决策输出当前机器人的场景(e.g:激光故障)，第三部分为==控制行为==，根据第二部分的输出的机器人场景(需要执行某个mission)，进行各种action的操作。


### 功能需求

- 机器人运行状况展示
- 查看机器人各节点运行的健康状态
- 机器人行为控制
- 机器人状态管理及对应的人机交互
- 用户通过界面操作机器人


### 系统核心模块设计

### 跟任务相关的控制

根据机器人整个运行过程，以及是否接收任务、停止任务、处于维修下把机器人系统的分为5个大状态

- 就绪态(机器人系统当前未执行任务，可以接收新的任务)
- 运行态(机器人系统正在执行任务，且可以正常运行，无法接收新的任务。有多个子状态)
- 维护态(一般人为进入，说明机器人此时无法去执行任务)
- 故障态(有模块发生问题，需要停止新任务、同时不能接收新任务)
- 充电态(机器人正在充电、此时会根据电量多少，以及策略来决定是否接收新任务)

### 人机交互及其他控制

- 状态指示灯
- 语言扬声器
- 本体触摸屏
- 脸部双显示屏
- 电源指示灯
- ......

### 核心模块设计

**核心图:**

![image](https://github.com/echopairs/blog/blob/master/pic/robot/agent.png?raw=true)

**1). report模块(跟状态相关的)**

通过ros subscriber/client/server/系统调用等方式采集、感知机器人的所有运行数据和各节点的健康状态，并缓存提供访问接口。同时对外上报机器人基本的运行状况(电量、速度等)以及各个节点的健康消息。(ros/mqtt等方式)

**2). state machine模块**

决策模块，根据定义五大状态的优先级分别为维护、故障、充电、运行(空闲)。启动一个后台线程，周期性根据report的数据及内部的一些历史状态，决策计算出当前的状态(e.g: 故障状态下的子状态激光故障)，输出结果到engine(引擎层)。

**3). engine模块(引擎层跟action相关的)**

引擎模块，根据决策层输出的结果映射到该结果需要执行的mission脚本文件(脚本语言的动态性)，脚本文件中为agent支持的各种元动作的组合操作。

==高可用==: 所有的元动作都可以根据需求自由组合。
    
==高扩展==: 新增一个子状态，只需要根据需求，编写一个misison文件，不影响引擎和决策模块代码。同时修改配置文件，支持该子状态映射到该misison文件中。

==可动态改变==: 通过修改脚本文件而不需要重新build，实现动态性。

**4). service层**

用于接收ui节点以及其他节点操作机器人的入口

**运行图**
![image](https://github.com/echopairs/blog/blob/master/pic/robot/running.png?raw=true)


